<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>【编译原理大作业】Tiny+的三地址码 | Four&#39;s</title><meta name="description" content="&amp;emsp;&amp;emsp;咕得有点久了&amp;emsp;&amp;emsp;这是编译原理大作业的第二步：进行语义分析，生成三地址码。"><meta property="og:type" content="article"><meta property="og:title" content="【编译原理大作业】Tiny+的三地址码"><meta property="og:url" content="http://kqp.world/Tiny+3addrcode/index.html"><meta property="og:site_name" content="Four&#39;s"><meta property="og:description" content="&amp;emsp;&amp;emsp;咕得有点久了&amp;emsp;&amp;emsp;这是编译原理大作业的第二步：进行语义分析，生成三地址码。"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-08-11T08:32:19.000Z"><meta property="article:modified_time" content="2024-04-24T03:59:22.798Z"><meta property="article:author" content="尘雨橙"><meta property="article:tag" content="编译器"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://kqp.world/Tiny+3addrcode/index.html"><link rel="alternate" href="/atom.xml" title="Four&#39;s" type="application/atom+xml"><link rel="icon" href="/favicon_you_3.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" rel="stylesheet"><meta name="generator" content="Hexo 6.2.0"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.png" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">尘雨橙</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">OIACMer / HKU_CS / LLer / TCS</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i></small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="Search"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">Home</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">Archives</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">Categories</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">Tags</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">Links</span></a></li><li class="menu-item menu-item-about"><a href="/personal/index"><i class="icon icon-cup-fill"></i> <span class="menu-title">About</span></a></li></ul><ul class="social-links"><li><a href="mailto:kuangqp1217@qq.com" target="_blank" title="Email" data-toggle="tooltip" data-placement="top"><i class="icon icon-email"></i></a></li><li><a href="http://wpa.qq.com/msgrd?v=3&uin=940240973&site=qq&menu=yes" target="_blank" title="Qq" data-toggle="tooltip" data-placement="top"><i class="icon icon-qq"></i></a></li><li><a href="https://twitter.com/yuan_four" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://github.com/l2l7l9p" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">Board</h3><div class="widget-body"><div id="board"><div class="content"><p>总有一天会学习前端，亲自操刀改造博客的。（发出鸽子的声音）</p></div></div></div></div><div class="widget"><h3 class="widget-title">Categories</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/OI-XCPC/">OI/XCPC</a><span class="category-list-count">201</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCS/">TCS</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/project/">project</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%80%BB%E7%BB%93%E4%B8%8E%E6%B8%B8%E8%AE%B0/">总结与游记</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E5%86%99/">杂写</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%8E%A9/">玩</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E6%89%8Bacademy/">随手academy</a><span class="category-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Tag Cloud</h3><div class="widget-body tagcloud"><a href="/tags/CPU/" style="font-size:13px">CPU</a> <a href="/tags/RNN/" style="font-size:13px">RNN</a> <a href="/tags/ZKP/" style="font-size:13.07px">ZKP</a> <a href="/tags/complexity/" style="font-size:13.14px">complexity</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size:13px">操作系统</a> <a href="/tags/%E7%A8%8B%E8%AE%BE/" style="font-size:13.07px">程设</a> <a href="/tags/%E7%AE%97%E6%B3%95-2-SAT/" style="font-size:13.07px">算法_2-SAT</a> <a href="/tags/%E7%AE%97%E6%B3%95-DP/" style="font-size:13.93px">算法_DP</a> <a href="/tags/%E7%AE%97%E6%B3%95-FFT-NTT/" style="font-size:13.43px">算法_FFT/NTT</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E4%BD%8D%E8%BF%90%E7%AE%97/" style="font-size:13.71px">算法_位运算</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%81%8F%E5%BA%8F%E5%85%B3%E7%B3%BB/" style="font-size:13.07px">算法_偏序关系</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%87%A0%E4%BD%95/" style="font-size:13.07px">算法_几何</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%88%86%E6%B2%BB/" style="font-size:13.14px">算法_分治</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%8D%9A%E5%BC%88/" style="font-size:13.07px">算法_博弈</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%90%AF%E5%8F%91%E5%BC%8F%E5%90%88%E5%B9%B6/" style="font-size:13.07px">算法_启发式合并</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%9B%BE%E8%AE%BA/" style="font-size:13.57px">算法_图论</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%A4%9A%E9%A1%B9%E5%BC%8F-%E7%94%9F%E6%88%90%E5%87%BD%E6%95%B0/" style="font-size:13.5px">算法_多项式/生成函数</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size:13.36px">算法_字符串</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%B9%B3%E8%A1%A1%E6%A0%91-set/" style="font-size:13.07px">算法_平衡树/set</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%B9%B3%E8%A1%A1%E8%A7%84%E5%88%92%EF%BC%88%E5%AE%9A%E6%9C%9F%E9%87%8D%E6%9E%84%EF%BC%89/" style="font-size:13px">算法_平衡规划（定期重构）</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E5%B9%B6%E6%9F%A5%E9%9B%86/" style="font-size:13.29px">算法_并查集</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%89%AB%E6%8F%8F%E7%BA%BF/" style="font-size:13.07px">算法_扫描线</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%95%B0%E5%AD%A6/" style="font-size:13.07px">算法_数学</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%95%B0%E8%AE%BA/" style="font-size:13.86px">算法_数论</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%9C%80%E7%9F%AD%E8%B7%AF%E6%A8%A1%E5%9E%8B/" style="font-size:13.21px">算法_最短路模型</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%9E%84%E9%80%A0%E9%A2%98/" style="font-size:13.64px">算法_构造题</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%9E%90%E5%90%88%E6%A0%91/" style="font-size:13px">算法_析合树</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%A0%91%E9%93%BE%E5%89%96%E5%88%86/" style="font-size:13.14px">算法_树链剖分</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%A0%B9%E5%8F%B7%E5%B9%B3%E8%A1%A1/" style="font-size:13.21px">算法_根号平衡</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E6%A6%82%E7%8E%87%E4%B8%8E%E6%9C%9F%E6%9C%9B/" style="font-size:13.29px">算法_概率与期望</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E7%82%B9%E5%88%86%E6%B2%BB/" style="font-size:13.14px">算法_点分治</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E7%8E%AF%E5%A5%97%E6%A0%91/" style="font-size:13.07px">算法_环套树</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95/" style="font-size:13.29px">算法_矩阵乘法</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84%E8%84%91%E6%B4%9E/" style="font-size:14px">算法_神奇的脑洞</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/" style="font-size:13.21px">算法_线性代数</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E7%BA%BF%E6%AE%B5%E6%A0%91/" style="font-size:13.79px">算法_线段树</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E7%BD%91%E7%BB%9C%E6%B5%81-%E5%8C%B9%E9%85%8D/" style="font-size:13.5px">算法_网络流/匹配</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E7%BE%A4%E8%AE%BA/" style="font-size:13.07px">算法_群论</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E8%8E%AB%E9%98%9F-%E5%88%86%E5%9D%97/" style="font-size:13.43px">算法_莫队/分块</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E8%AE%A1%E6%95%B0/" style="font-size:13.21px">算法_计数</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E8%B4%AA%E5%BF%83/" style="font-size:13.21px">算法_贪心</a> <a href="/tags/%E7%AE%97%E6%B3%95-%E9%9A%8F%E6%9C%BA%E5%A4%A7%E6%B3%95/" style="font-size:13.36px">算法_随机大法</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size:13.07px">编译器</a></div></div><div class="widget"><h3 class="widget-title">Archive</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">April 2025</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Recent Posts</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E6%9D%82%E5%86%99/">杂写</a></p><p class="item-title"><a href="/academia_vs_industry/" class="title">理论与应用之争——一个回归视角</a></p><p class="item-date"><time datetime="2025-04-17T03:50:06.000Z" itemprop="datePublished">2025-04-17</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E7%8E%A9/">玩</a></p><p class="item-title"><a href="/lovelive_asia_tour_2024/" class="title">LoveLive 系列亚巡广州上海场</a></p><p class="item-date"><time datetime="2024-10-08T07:55:58.000Z" itemprop="datePublished">2024-10-08</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/OI-XCPC/">OI/XCPC</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E6%80%BB%E7%BB%93%E4%B8%8E%E6%B8%B8%E8%AE%B0/">总结与游记</a></p><p class="item-title"><a href="/2023_WF/" class="title">2023 World Final 真·退役记</a></p><p class="item-date"><time datetime="2024-04-20T06:37:00.000Z" itemprop="datePublished">2024-04-20</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E7%8E%A9/">玩</a></p><p class="item-title"><a href="/koushien/" class="title">LoveLive 小组甲子园 + 横滨镰仓乱逛</a></p><p class="item-date"><time datetime="2024-03-12T13:59:57.000Z" itemprop="datePublished">2024-03-12</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/TCS/">TCS</a></p><p class="item-title"><a href="/graphpoly/" class="title">图论多项式(Graph Polynomials)</a></p><p class="item-date"><time datetime="2024-03-08T15:32:40.000Z" itemprop="datePublished">2024-03-08</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-Tiny+3addrcode" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">【编译原理大作业】Tiny+的三地址码</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/Tiny+3addrcode/" class="article-date"><time datetime="2021-08-11T08:32:19.000Z" itemprop="datePublished">2021-08-11</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/project/">project</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" rel="tag">编译器</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/Tiny+3addrcode/#comments" class="article-comment-link">Comments</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>&emsp;&emsp;<del>咕得有点久了</del><br>&emsp;&emsp;这是编译原理大作业的第二步：进行语义分析，生成三地址码。<br><span id="more"></span><br>&emsp;&emsp;三地址码是一种平台无关的中间代码（类似汇编，但没到 x86、MIPS 那么具体），特点是：1、变量和 label 无需换成具体的地址，能区分清楚就行（例如嵌套作用域的同名变量要区分开）；2、寄存器无限量，不需要考虑有限的寄存器池；3、没有关于 CPU、操作系统的对接细节。这还是一个比较中间层次的东西，要生成具体的可执行代码时，不同平台可以直接拿三地址码来翻译。<br>&emsp;&emsp;有了上一步的语法树之后，这一部分就不需要额外的工具了，就在语法树上完成需要的操作。尽管语义分析可以在语法分析的过程中完成，但是建出树以后再操作会好写一点，反正时间复杂度是不变的。<br>&emsp;&emsp;参考书用龙书即可（Compilers Principles, Techniques, Tools. second version），龙书已经把框架给得很清楚了，虽然略去了一堆坑 b 的细节。。。<br>&emsp;&emsp;三地址码的格式也用龙书的。</p><p>&emsp;&emsp;<a target="_blank" rel="noopener" href="https://github.com/l2l7l9p/Tiny">项目地址</a></p><h2 id="语义分析"><a href="#语义分析" class="headerlink" title="语义分析"></a>语义分析</h2><p>&emsp;&emsp;语义分析是比较大的概念，对于不同的程序有不同的语义分析内容，例如，基于<a target="_blank" rel="noopener" href="https://github.com/l2l7l9p/Tiny/blob/master/Tiny+EBNF.md">我的语言定义</a>，可以进行包括但不限于如下的语义分析：</p><ul><li>检查整个程序是否有且仅有一个 <code>MAIN</code> 标识的函数；</li><li>检查变量、函数引用前是否声明；</li><li>检查变量、函数是否重定义；</li><li>类型检查与类型强制转换。目前 Tiny+ 程序可用的类型只有 <code>BOOL</code>,<code>CHAR</code>,<code>INT</code>,<code>REAL</code>，它们之间都可以强制转换，且已按优先级从低到高排好。因此可以不用进行类型检查，只需在类型不匹配时强制类型转换（低优先级转换到高优先级）；</li><li>调用函数时检查参数及类型是否匹配；</li><li>检查函数是否以 <code>RETURN</code> 结尾，若不是，需提出 warning。</li></ul><p>&emsp;&emsp;我们可以在生成三地址码的过程中顺便做这些事情。</p><h2 id="符号表"><a href="#符号表" class="headerlink" title="符号表"></a>符号表</h2><p>&emsp;&emsp;符号表是一个栈结构，用于记录生成代码中遇到的各种符号，以便在真正的编译中替换成地址。本次的符号表需记录以下内容：</p><ul><li>定义的变量；</li><li>定义的函数；</li><li>控制流跳转用的 label</li></ul><p>&emsp;&emsp;具体实现，在基类 <code>node</code> 中定义符号表：(26 行)<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Symbol_t</span>&#123;</span></span><br><span class="line">    SB_VAR,</span><br><span class="line">    SB_FUNC,</span><br><span class="line">    SB_LABEL,</span><br><span class="line">    SB_NOTFOUND</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Symbol</span> &#123;</span></span><br><span class="line">    Symbol_t type;</span><br><span class="line">    <span class="built_in">string</span> label;</span><br><span class="line">    Var_t varType;</span><br><span class="line">    node *ref;        <span class="comment">// reference to that symbol</span></span><br><span class="line"></span><br><span class="line">    Symbol(Symbol_t ty,<span class="built_in">string</span> lb=<span class="string">&quot;&quot;</span>,Var_t vt=V_BOOL,node *rf=nullptr) &#123;</span><br><span class="line">        type=ty, varType=vt, label=lb, ref=rf;</span><br><span class="line">    &#125;</span><br><span class="line">    Symbol() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">unordered_map</span>&lt;<span class="built_in">string</span>,Symbol&gt; SymbolTabType;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    public:</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">static</span> <span class="built_in">vector</span>&lt;SymbolTabType&gt; symbolTab;         <span class="comment">// symbol table. It is a stack</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> EOCFCnt, elseCnt, loopCnt, varCnt;   <span class="comment">// label count</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>&emsp;&emsp;用 <code>std::vector</code> 来模拟符号表的栈（为了可以遍历栈元素而不用 <code>std::stack</code>）；栈的每一项是一个 <code>unordered_map&lt;string,Symbol&gt;</code>，用于映射符号到其信息；信息用 <code>struct Symbol</code> 来记录，内容包括符号类型、符号的 label、符号的运算类型（<code>BOOL,INT</code> 等）、代表该符号的语法树节点。<br>&emsp;&emsp;在实际编译中，只有跨文件的符号需要记录 label 以用于链接，其余符号可直接记录其内存地址，因为符号最终就是要替换成地址的。<br>&emsp;&emsp;另使用 <code>EOCFCnt, elseCnt, loopCnt, varCnt</code> 四个计数器来生成控制流跳转 label 标号、else 跳转 label 标号、循环跳转 label 标号、变量及寄存器唯一标号。使用计数器的目的就是使得 label、变量和寄存器标号变得唯一。</p><h3 id="从符号表中查找符号"><a href="#从符号表中查找符号" class="headerlink" title="从符号表中查找符号"></a>从符号表中查找符号</h3><p>&emsp;&emsp;从符号表中查找一个符号，就从栈顶往栈底依次查找，找到了返回相应的 <code>Symbol</code> 信息，找不到就返回 <code>NOTFOUND</code>。<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Symbol <span class="title function_">find_symbol</span><span class="params">(<span class="built_in">string</span> s)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=node::symbolTab.size()<span class="number">-1</span>; i&gt;=<span class="number">0</span>; i--)</span><br><span class="line">        <span class="keyword">if</span> (node::symbolTab[i].count(s)) <span class="keyword">return</span> node::symbolTab[i][s];</span><br><span class="line">    <span class="keyword">return</span> Symbol(SB_NOTFOUND);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="控制流结束跳转-label"><a href="#控制流结束跳转-label" class="headerlink" title="控制流结束跳转 label"></a>控制流结束跳转 label</h3><p>&emsp;&emsp;If、For 等控制流需要一个继承属性 label 表示该控制流结束之后跳转到何处。这个继承属性在符号表中实现，用 <code>%EOCF</code> 符号（End Of Control Flow）来表示该语句结束后应跳转到的 label。这样 If、For 等节点具体生成代码的时候，只要从符号表中查找最近的 <code>%EOCF</code>，就知道如何跳转了。</p><h2 id="三地址码"><a href="#三地址码" class="headerlink" title="三地址码"></a>三地址码</h2><p>&emsp;&emsp;在基类 <code>node</code> 中定义虚函数 <code>generate_3addr_code()</code>，即每个节点类实现自己的三地址码生成过程。<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">vector</span>&lt;<span class="built_in">pair</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&gt; Codes;      <span class="comment">// format: pair&lt;label,instruction&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">node</span>&#123;</span></span><br><span class="line">	public:	</span><br><span class="line">	...</span><br><span class="line">	Codes codes;</span><br><span class="line">	virtual <span class="type">bool</span> <span class="title function_">generate_3addr_code</span><span class="params">()</span> &#123;&#125;      <span class="comment">// return 0 if compiled successfully</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>&emsp;&emsp;三地址码形如 <code>vector&lt;pair&lt;string,string&gt;&gt;</code>，每条指令代码用两个 <code>string</code> 表示，前一个 <code>string</code> 表示 label，后一个 <code>string</code> 表示指令。<br>&emsp;&emsp;本次实验中，label 和指令是多对一的关系，即相同名称的 label 一定指向同一条指令，但一条指令可以对应多个 label。这在实际编译中也是可行的，因为 label 的本质是内存地址，如果用内存地址代替 label 的记录，那么 label 和指令就是一一对应的了。<br>&emsp;&emsp;接下来分不同的节点类来说明 <code>generate_3addr_code()</code> 的实现，以及相应的语法检查。<p></p><h3 id="Program"><a href="#Program" class="headerlink" title="Program"></a>Program</h3><p>&emsp;&emsp;Program 是整个语法树的根，它新建一层符号表用于标记全局 label，调用它的子节点（MethodDecls）生成代码，并在整份代码开头补充一句 <code>goto mainFuncLabel</code> 使得程序跳到 <code>MAIN</code> 函数入口。<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">node_Program::generate_3addr_code</span><span class="params">()</span> &#123;</span><br><span class="line">    symbolTab.push_back(SymbolTabType());                   <span class="comment">// global label</span></span><br><span class="line">    <span class="type">bool</span> err=son[<span class="number">0</span>]-&gt;generate_3addr_code();</span><br><span class="line">    codes.push_back(<span class="built_in">make_pair</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;goto &quot;</span>+mainFuncLabel));   <span class="comment">// goto main function</span></span><br><span class="line">    add_codes(codes,son[<span class="number">0</span>]-&gt;codes);</span><br><span class="line">    symbolTab.pop_back();</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>&emsp;&emsp;<code>add_codes(a,b)</code> 是把 <code>b</code> 的代码加到 <code>a</code> 的末尾。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">add_codes</span><span class="params">(Codes &amp;a,Codes &amp;b)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (a.empty()) a=b;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">for</span>(<span class="keyword">auto</span> code:b) a.push_back(code);</span><br><span class="line">	b.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="MethodDecls"><a href="#MethodDecls" class="headerlink" title="MethodDecls"></a>MethodDecls</h3><p>&emsp;&emsp;该节点可以得到整个程序的函数列表。因此先把函数标识符添加到符号表中，生成它们的跳转 label（”__” 加函数名），这样就可以做到函数的调用与声明顺序无关。<br>&emsp;&emsp;此处顺便找出 <code>MAIN</code> 标识的函数，并检查是否唯一。<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> node::mainFuncLabel=<span class="string">&quot;NO&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">node_MethodDecls::generate_3addr_code</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">bool</span> err=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">// add function names to symbol table, and find &#x27;main&#x27;</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> xp:son) &#123;</span><br><span class="line">        node_MethodDecl *x=(node_MethodDecl*)xp;</span><br><span class="line">        <span class="built_in">string</span> &amp;funcName=((node_Id*)(x-&gt;son[<span class="number">1</span>]))-&gt;name;</span><br><span class="line">        symbolTab.back()[funcName]=Symbol(SB_FUNC,<span class="string">&quot;__&quot;</span>+funcName,((node_Type*)(x-&gt;son[<span class="number">0</span>]))-&gt;varType,xp);</span><br><span class="line">        <span class="keyword">if</span> (x-&gt;isMain) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mainFuncLabel!=<span class="string">&quot;NO&quot;</span>) semantic_error(<span class="string">&quot;more than one main function&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span> mainFuncLabel=<span class="string">&quot;__&quot;</span>+funcName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mainFuncLabel==<span class="string">&quot;NO&quot;</span>) semantic_error(<span class="string">&quot;no main function&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> xp:son) &#123;     <span class="comment">// enumerate each method</span></span><br><span class="line">        <span class="comment">// each method generates its codes and add to this-&gt;codes</span></span><br><span class="line">        node_MethodDecl *x=(node_MethodDecl*)xp;</span><br><span class="line">		err|=x-&gt;generate_3addr_code();</span><br><span class="line">		add_codes(codes,x-&gt;codes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里用到了语义报错操作。简单地在节点类里记录一下当前节点对应的代码的行号（新建节点时保存 flex 的 <code>yylineno</code> 即可），就可以报错时输出行号了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> semantic_error(message) &#123;\</span></span><br><span class="line"><span class="meta">	cout &lt;&lt; lineno &lt;&lt; <span class="string">&quot;: semantic error: &quot;</span> &lt;&lt; message &lt;&lt; endl;\</span></span><br><span class="line"><span class="meta">	err=1;\</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> semantic_warning(message) &#123;\</span></span><br><span class="line"><span class="meta">	cout &lt;&lt; lineno &lt;&lt; <span class="string">&quot;: warning: &quot;</span> &lt;&lt; message &lt;&lt; endl;\</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure><p></p><h3 id="MethodDecl"><a href="#MethodDecl" class="headerlink" title="MethodDecl"></a>MethodDecl</h3><p>&emsp;&emsp;该节点是具体的一个函数。首先新建一层符号表，表示新一层的局部变量，以及在表里记录当前所在的函数信息（<code>return</code> 要用）；然后处理形参表，将形参加入局部变量；接着生成函数内的 statements 的具体代码；最后检查代码的最后一条指令是否是 <code>return</code>。<br>&emsp;&emsp;这里需要新建一个 <code>%EOCF</code> 符号，指向最后的 <code>return</code>，即如果该函数最后一条语句是 If 等控制流，那么这个 If 语句就知道它要跳转到最后的 <code>return</code> 了。（如果代码自己生成了 <code>return</code>，那么这个符号也是用不上的。）<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">node_MethodDecl::generate_3addr_code</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">bool</span> err=<span class="number">0</span>;</span><br><span class="line">    symbolTab.push_back(SymbolTabType());                            <span class="comment">// local label</span></span><br><span class="line">    symbolTab.back()[<span class="string">&quot;%EOCF&quot;</span>]=Symbol(SB_LABEL,<span class="string">&quot;EOCF_&quot;</span>+to_string(EOCFCnt++));    <span class="comment">// &#x27;End Of Control Flow&#x27; label</span></span><br><span class="line">    <span class="comment">// mark which function we are in</span></span><br><span class="line">    symbolTab.back()[<span class="string">&quot;%FUNC&quot;</span>]=Symbol(SB_LABEL,<span class="string">&quot;&quot;</span>,((node_Type*)son[<span class="number">0</span>])-&gt;varType,(node*)this);</span><br><span class="line">    err|=((node_FormalParams*)son[<span class="number">2</span>])-&gt;add_formal_params();        <span class="comment">// formal parameters</span></span><br><span class="line">    <span class="keyword">if</span> (son.size()&gt;=<span class="number">4</span>) &#123;</span><br><span class="line">        err|=son[<span class="number">3</span>]-&gt;generate_3addr_code();                        <span class="comment">// statements</span></span><br><span class="line">        add_codes(codes,son[<span class="number">3</span>]-&gt;codes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// check if the last instruction is return</span></span><br><span class="line">    <span class="keyword">if</span> (codes.empty() || codes.back().second!=<span class="string">&quot;return&quot;</span>) &#123;</span><br><span class="line">        semantic_warning(<span class="string">&quot;lack of return at the end of function&quot;</span>);</span><br><span class="line">        codes.push_back(<span class="built_in">make_pair</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;return&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    codes.back().first.insert(<span class="number">0</span>,symbolTab.back()[<span class="string">&quot;%EOCF&quot;</span>].label+<span class="string">&quot;: &quot;</span>);</span><br><span class="line">    codes[<span class="number">0</span>].first.insert(<span class="number">0</span>,<span class="string">&quot;__&quot;</span>+((node_Id*)son[<span class="number">1</span>])-&gt;name+<span class="string">&quot;: &quot;</span>);    <span class="comment">// mark the entrance of function</span></span><br><span class="line">    symbolTab.pop_back();</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="Statements"><a href="#Statements" class="headerlink" title="Statements"></a>Statements</h3><p>&emsp;&emsp;该节点表示语句的集合，同时也表示被 <code>BEGIN, END</code> 包起来的一个区块。所以逻辑就是先新建一层符号表表示局部变量，然后每条语句依次生成。<br>&emsp;&emsp;但是遇到控制流语句的时候，要判断该语句是否是最后一句，如果是，那么 <code>%EOCF</code> 沿用祖先的（即控制流结束后跳转到祖先指定的地方），否则新建一个 <code>%EOCF</code> 指向下一条语句，并在下一条语句的第一个指令加上这个 label。</p><p>&emsp;&emsp;听起来很简单</p><p>&emsp;&emsp;但实际上。。。细思极恐，所谓“<code>%EOCF</code>指向下一条语句，并在下一条语句的第一个指令加上这个 label”，它可能需要处理这样的代码：<br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">IF (z==1) BEGIN</span><br><span class="line">	IF (i==1) BEGIN</span><br><span class="line">		IF (y==2) BEGIN</span><br><span class="line">		END</span><br><span class="line">		BEGIN</span><br><span class="line">		END</span><br><span class="line">		BEGIN</span><br><span class="line">			BEGIN</span><br><span class="line">			END</span><br><span class="line">		END</span><br><span class="line">	END</span><br><span class="line">	BEGIN</span><br><span class="line">		BEGIN</span><br><span class="line">		END</span><br><span class="line">	END</span><br><span class="line">	BEGIN</span><br><span class="line">	END</span><br><span class="line">END</span><br><span class="line">BEGIN</span><br><span class="line">	INT a;</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p></p><p>&emsp;&emsp;这里的三个 if 全部都有“下一条语句”，但由于“下一条语句”为空，因此它们最终全都要使用祖先的 <code>%EOCF</code>，而不能新建 label 然后加到“下一条语句”。<br>&emsp;&emsp;有同学说，既然这是空语句产生的 bug，那在生成语法树时就把这些空语句规避掉，不建立节点，不就好了？其一，空语句结构可能很复杂（比如这样嵌套的），从语法上处理它是比较麻烦的；其二，空语句不一定是形式上的空语句，还可以是实质空语句（就是写了非平凡的代码但生成的是空语句，例如因代码优化导致的空语句，例如局部变量定义也是不产生代码的），这导致一个不可规避的问题。</p><p>&emsp;&emsp;解决方法是，遇到控制流，就把这一段连续的控制流语句抠出来，然后倒着做，相当于先要找到真正的非空的“下一条语句”在哪，然后倒序依次在这条语句的开头新建 <code>%EOCF</code>（或是决定用祖先的）给上一条语句用。<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">isControlFlow</span><span class="params">(node *x)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> (!x-&gt;son.empty() &amp;&amp; (x-&gt;son[<span class="number">0</span>]-&gt;nodeType==IFSTMT || x-&gt;son[<span class="number">0</span>]-&gt;nodeType==FORSTMT));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">node_Statements::generate_3addr_code</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">bool</span> err=<span class="number">0</span>;</span><br><span class="line">	symbolTab.push_back(SymbolTabType());		<span class="comment">// local label</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;son.size(); i++) &#123;</span><br><span class="line">		node_Statement *x=(node_Statement*)son[i];</span><br><span class="line">		<span class="keyword">if</span> (isControlFlow(x)) &#123;</span><br><span class="line">			<span class="comment">// for continuous control flows, generate codes in reverse order,</span></span><br><span class="line">			<span class="comment">// to avoid bugs of EOCF label with empty statement</span></span><br><span class="line">			<span class="built_in">vector</span>&lt;node*&gt; CFlist;</span><br><span class="line">			<span class="type">int</span> j=i;							<span class="comment">// i: the first CF;   j: after the last CF</span></span><br><span class="line">			<span class="keyword">for</span>(; ; j++) &#123;</span><br><span class="line">				<span class="keyword">for</span>(; j&lt;son.size() &amp;&amp; isControlFlow(son[j]); j++) CFlist.push_back(son[j]);</span><br><span class="line">				<span class="keyword">if</span> (j&gt;=son.size()) <span class="keyword">break</span>;</span><br><span class="line">				err|=son[j]-&gt;generate_3addr_code();</span><br><span class="line">				<span class="keyword">if</span> (!son[j]-&gt;codes.empty()) <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (j&lt;son.size()) &#123;</span><br><span class="line">				<span class="built_in">string</span> eocf=<span class="string">&quot;EOCF_&quot;</span>+to_string(EOCFCnt++);</span><br><span class="line">				symbolTab.back()[<span class="string">&quot;%EOCF&quot;</span>]=Symbol(SB_LABEL,eocf);</span><br><span class="line">				son[j]-&gt;codes[<span class="number">0</span>].first.insert(<span class="number">0</span>,eocf+<span class="string">&quot;: &quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span>(<span class="type">int</span> k=CFlist.size()<span class="number">-1</span>; k&gt;=<span class="number">0</span>; k--) &#123;</span><br><span class="line">				err|=CFlist[k]-&gt;generate_3addr_code();</span><br><span class="line">				<span class="keyword">if</span> (k&gt;i) &#123;</span><br><span class="line">					<span class="built_in">string</span> eocf=<span class="string">&quot;EOCF_&quot;</span>+to_string(EOCFCnt++);</span><br><span class="line">					symbolTab.back()[<span class="string">&quot;%EOCF&quot;</span>]=Symbol(SB_LABEL,eocf);</span><br><span class="line">					CFlist[k]-&gt;codes[<span class="number">0</span>].first.insert(<span class="number">0</span>,eocf+<span class="string">&quot;: &quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			symbolTab.back().erase(<span class="string">&quot;%EOCF&quot;</span>);</span><br><span class="line">			<span class="keyword">for</span>(; i&lt;=j; i++) <span class="keyword">if</span> (i&lt;son.size()) add_codes(codes,son[i]-&gt;codes);</span><br><span class="line">			i--;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			err|=x-&gt;generate_3addr_code();		<span class="comment">// each statement</span></span><br><span class="line">			add_codes(codes,x-&gt;codes);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	symbolTab.pop_back();</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="简单语句"><a href="#简单语句" class="headerlink" title="简单语句"></a>简单语句</h3><p>&emsp;&emsp;<code>LocalVarDecl, AssignStmt, ReturnStmt, ReadStmt, WriteStmt</code> 都是单条简单语句，它们生成的代码都较为简单，代码不赘述。<br>&emsp;&emsp;<code>ReturnStmt</code> 需要注意若返回表达式的类型与函数类型不匹配，则要强制类型转换。<br>&emsp;&emsp;<code>ReadStmt, WriteStmt</code> 当作函数调用处理。</p><p>&emsp;&emsp;以 <code>AssignStmt</code> 为例：<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">node_AssignStmt::generate_3addr_code</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">bool</span> err=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">string</span> &amp;leftName=((node_Id*)son[<span class="number">0</span>])-&gt;name;</span><br><span class="line">	Symbol left=find_symbol(leftName);</span><br><span class="line">	<span class="keyword">if</span> (left.type==SB_NOTFOUND) semantic_error(<span class="string">&quot;undeclared identifier &#x27;&quot;</span>+leftName+<span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (left.type!=SB_VAR) semantic_error(<span class="string">&quot;identifier &#x27;&quot;</span>+leftName+<span class="string">&quot;&#x27; is not a variable&quot;</span>);</span><br><span class="line">	err|=son[<span class="number">1</span>]-&gt;generate_3addr_code();</span><br><span class="line">	add_codes(codes,son[<span class="number">1</span>]-&gt;codes);</span><br><span class="line">	codes.push_back(<span class="built_in">make_pair</span>(<span class="string">&quot;&quot;</span>,left.label+<span class="string">&quot; = &quot;</span>+((node_Expression*)son[<span class="number">1</span>])-&gt;resultLabel));</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="IfStmt"><a href="#IfStmt" class="headerlink" title="IfStmt"></a>IfStmt</h3><p>&emsp;&emsp;If 是一个控制流，有 else 和没 else 的生成规则分别为：<br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;codes of expression of condition&gt;</span><br><span class="line">ifFalse &lt;condition&gt; goto %EOCF</span><br><span class="line">&lt;codes of ifTrue&gt;</span><br><span class="line">%EOCF: ...</span><br></pre></td></tr></table></figure><br>&emsp;&emsp;和<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;codes of expression of condition&gt;</span><br><span class="line">ifFalse &lt;condition&gt; goto else</span><br><span class="line">&lt;codes of ifTrue&gt;</span><br><span class="line">goto %EOCF</span><br><span class="line">else: &lt;codes of else&gt;</span><br><span class="line">%EOCF: ...</span><br></pre></td></tr></table></figure><br>&emsp;&emsp;注意 ifTrue 和 else 的语句都要新建一层符号表。这里的 else label 要用 <code>elseCnt</code> 计数器来生成唯一标号。具体代码翻译该逻辑即可，不赘述。<p></p><h3 id="ForStmt"><a href="#ForStmt" class="headerlink" title="ForStmt"></a>ForStmt</h3><p>&emsp;&emsp;For 语句共 4 个部分：初始化语句 <code>init</code>、循环条件 <code>condition</code>、每次循环结束后执行的操作 <code>afterLoop</code>、循环体 <code>loop</code>。生成规则为：<br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;codes of init&gt;</span><br><span class="line">&lt;codes of condition&gt;</span><br><span class="line">loop: ifFalse &lt;condition&gt; goto %EOCF</span><br><span class="line">&lt;codes of loop&gt;</span><br><span class="line">&lt;codes of afterLoop&gt;</span><br><span class="line">goto loop</span><br><span class="line">%EOCF: ...</span><br></pre></td></tr></table></figure><p></p><h3 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h3><p>&emsp;&emsp;每个 Expression 类要得到它的代码、返回类型、存放结果的 label。</p><ul><li>若为二元算术运算，则先生成左右两个子 Expression 的代码，然后两个返回值取类型优先级较高的作为最终结果类型，接着对两边进行强制类型转换，最后进行左右两个返回值的运算；</li><li>若为二元逻辑运算，则同上，但最后结果类型是 <code>BOOL</code></li><li>若为一元运算，则先生成子 Expression 的代码，然后进行运算；</li><li>若为立即数，则结果直接赋为该立即数；</li><li>若为变量，则从符号表中寻找该变量的 label 作为结果 label；</li><li>若为函数调用，则先生成实参的 Expression 的代码（并检查是否与形参匹配），接着用 <code>param</code> 语句传递参数，然后调用函数，最后取出返回值放到一个寄存器。</li></ul><p>&emsp;&emsp;这里是把布尔表达式和算数表达式等同对待了，但实际编译器是区别对待的，比如 or 运算，前件成立了是不判断后件的。本来这只是个代码优化，但它已经形成一种编程规范了，如果前件成立仍然判断后件会导致很多程序出错的。</p><p>&emsp;&emsp;至此，三地址码的生成就基本说完了。</p><h2 id="后续内容"><a href="#后续内容" class="headerlink" title="后续内容"></a>后续内容</h2><p>&emsp;&emsp;做一做前端交互，用 <code>-o</code> 选项把代码输出到指定文件啥的，改一下上次的代码不要因为存在语法错误就把整棵树析构了，使其能够同时检查语法错误和语义错误，最好再按行号排个序输出。<br>&emsp;&emsp;我现在的语言定义里还有很多东西没做，例如数组、指针、break、continue 之类的，因此这个语言还不是很完备。<br>&emsp;&emsp;再后续，就是代码优化了，平台无关代码优化的部分龙书讲了很多，都挺有趣的。<br>&emsp;&emsp;<del>但是学期结束了哈哈哈哈哈哈哈哈哈哈</del></p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="http://kqp.world/Tiny+3addrcode/" title="【编译原理大作业】Tiny+的三地址码" target="_blank" rel="external">http://kqp.world/Tiny+3addrcode/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.png" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">尘雨橙</span><small class="ml-1x">OIACMer / HKU_CS / LLer / TCS</small></a></h3><div>糖少许，盐少许</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/%E3%80%90SEERC%202020%20H%E3%80%91AND%20=%20OR%20%E9%A2%98%E8%A7%A3/" title="【SEERC 2020 H】AND = OR 题解"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a></li><li class="next"><a href="/%E3%80%902021%20Multi-University%202%20J%E3%80%91I%20love%20permutation%20%E9%A2%98%E8%A7%A3/" title="【2021 Multi-University 2 J】I love permutation 题解"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="mailto:kuangqp1217@qq.com" target="_blank" title="Email" data-toggle="tooltip" data-placement="top"><i class="icon icon-email"></i></a></li><li><a href="http://wpa.qq.com/msgrd?v=3&uin=940240973&site=qq&menu=yes" target="_blank" title="Qq" data-toggle="tooltip" data-placement="top"><i class="icon icon-qq"></i></a></li><li><a href="https://twitter.com/yuan_four" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://github.com/l2l7l9p" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!0,appId:"YsBbwGr5CQ2WyuobqGxOedtu-gzGzoHsz",appKey:"Wplm0hz1L65wFVye5hE8tOTf",placeholder:"Just go go",avatar:"mm",meta:meta,pageSize:"10",visitor:!1})</script></body></html>